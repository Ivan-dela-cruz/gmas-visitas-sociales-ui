import{w as W,b8 as L,y as V,r as n,j as e,b9 as q,A as D,G as a,S as h,aS as g,b1 as M,I as z,H as U,B as $,k as v,F as G,ba as H}from"./index-C1pIq2vl.js";import{A as N,a as J}from"./AnimateButton-BN0-O2OY.js";import{F as K,c as Q,a as E}from"./formik.esm-BJieVtAb.js";import{u as X}from"./useScriptRef-BQ8okiSi.js";import{s as Y,a as Z}from"./password-strength-CqriagFx.js";import{I as P}from"./InputLabel-Bx_DgBK8.js";import{F as u}from"./FormHelperText-DKDoT4uR.js";import{E as _}from"./Eye-D6moR2NK.js";import{E as ee}from"./EyeSlash-C2aIofKx.js";function se(){const k=X(),S=W(),[l]=L(),{isLoggedIn:C}=V(),[o,I]=n.useState(),[p,F]=n.useState(!1),[f,w]=n.useState(""),[B,j]=n.useState(!1),d=n.useMemo(()=>l.get("token")||"",[l]),m=n.useMemo(()=>l.get("username")||l.get("email")||"",[l]),R=!!m,T=()=>{F(!p)},A=s=>{s.preventDefault()},O=s=>{const r=Y(s);I(Z(r))};return n.useEffect(()=>{O("")},[]),n.useEffect(()=>{(async()=>{if(!d){w("El enlace de restablecimiento no contiene un token válido. Por favor, solicita uno nuevo."),j(!1);return}try{await H({token:d,userOrEmail:m||void 0}),w(""),j(!0)}catch(r){w((r==null?void 0:r.message)||"El enlace ha expirado o no es válido. Solicita un nuevo enlace de restablecimiento."),j(!1)}})()},[d,m]),e.jsx(e.Fragment,{children:e.jsx(K,{initialValues:{userOrEmail:m,password:"",confirmPassword:"",submit:null},validationSchema:Q().shape({userOrEmail:E().max(255).required("Usuario o correo es requerido"),password:E().max(255).required("La contraseña es obligatoria"),confirmPassword:E().required("Debe confirmar la contraseña").test("confirmPassword","Las contraseñas no coinciden. Por favor, verifica que sean idénticas.",(s,r)=>r.parent.password===s)}),onSubmit:async(s,{setErrors:r,setStatus:t,setSubmitting:i})=>{try{if(!d){t({success:!1}),r({submit:"El enlace de restablecimiento no contiene un token válido. Por favor, solicita uno nuevo."}),i(!1);return}if(!B){t({success:!1}),r({submit:f||"El enlace ha expirado o no es válido. Solicita un nuevo enlace de restablecimiento."}),i(!1);return}await q({token:d,userOrEmail:s.userOrEmail,newPassword:s.password,useToken:!0}),k.current&&(t({success:!0}),i(!1),D({open:!0,message:"¡Contraseña restablecida exitosamente!",variant:"alert",alert:{color:"success"}}),setTimeout(()=>{S(C?"/auth/login":"/login",{replace:!0})},1500))}catch(x){console.error(x),k.current&&(t({success:!1}),r({submit:x.message||"Ocurrió un error al restablecer la contraseña. Por favor, intenta de nuevo."}),i(!1))}},children:({errors:s,handleBlur:r,handleChange:t,handleSubmit:i,isSubmitting:x,touched:c,values:b})=>e.jsx("form",{noValidate:!0,onSubmit:i,children:e.jsxs(a,{container:!0,spacing:3,children:[e.jsxs(a,{item:!0,xs:12,children:[e.jsxs(h,{spacing:1,children:[e.jsx(P,{htmlFor:"userOrEmail-reset",children:"Usuario o correo"}),e.jsx(g,{fullWidth:!0,error:!!(c.userOrEmail&&s.userOrEmail),id:"userOrEmail-reset",type:"text",value:b.userOrEmail,name:"userOrEmail",onBlur:r,onChange:t,placeholder:"Ingresa tu usuario o correo",disabled:R})]}),c.userOrEmail&&s.userOrEmail&&e.jsx(u,{error:!0,id:"helper-text-userOrEmail-reset",children:s.userOrEmail})]}),e.jsxs(a,{item:!0,xs:12,children:[e.jsxs(h,{spacing:1,children:[e.jsx(P,{htmlFor:"password-reset",children:"Contraseña"}),e.jsx(g,{fullWidth:!0,error:!!(c.password&&s.password),id:"password-reset",type:p?"text":"password",value:b.password,name:"password",onBlur:r,onChange:y=>{t(y),O(y.target.value)},endAdornment:e.jsx(M,{position:"end",children:e.jsx(z,{"aria-label":"toggle password visibility",onClick:T,onMouseDown:A,edge:"end",color:"secondary",children:p?e.jsx(_,{}):e.jsx(ee,{})})}),placeholder:"Ingresa tu contraseña"})]}),c.password&&s.password&&e.jsx(u,{error:!0,id:"helper-text-password-reset",children:s.password}),e.jsx(U,{fullWidth:!0,sx:{mt:2},children:e.jsxs(a,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(a,{item:!0,sx:{flex:1},children:e.jsx($,{sx:{bgcolor:o==null?void 0:o.color,width:"100%",height:6,borderRadius:"7px",boxShadow:`0 0 8px ${o==null?void 0:o.color}`}})}),e.jsx(a,{item:!0,children:e.jsx(v,{variant:"subtitle2",fontSize:"0.8rem",fontWeight:600,children:o==null?void 0:o.label})})]})})]}),e.jsxs(a,{item:!0,xs:12,children:[e.jsxs(h,{spacing:1,children:[e.jsx(P,{htmlFor:"confirm-password-reset",children:"Confirmar Contraseña"}),e.jsx(g,{fullWidth:!0,error:!!(c.confirmPassword&&s.confirmPassword),id:"confirm-password-reset",type:"password",value:b.confirmPassword,name:"confirmPassword",onBlur:r,onChange:t,placeholder:"Confirma tu contraseña"})]}),c.confirmPassword&&s.confirmPassword&&e.jsx(u,{error:!0,id:"helper-text-confirm-password-reset",children:s.confirmPassword})]}),s.submit&&e.jsx(a,{item:!0,xs:12,children:e.jsx(u,{error:!0,children:s.submit})}),f&&!s.submit&&e.jsx(a,{item:!0,xs:12,children:e.jsx(u,{error:!0,children:f})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(N,{children:e.jsx(G,{disableElevation:!0,disabled:x,fullWidth:!0,size:"large",type:"submit",variant:"contained",color:"primary",children:"Restablecer Contraseña"})})})]})})})})}function ue(){return e.jsx(J,{children:e.jsxs(a,{container:!0,spacing:3,children:[e.jsx(a,{item:!0,xs:12,children:e.jsxs(h,{sx:{mb:{xs:-.5,sm:.5}},spacing:1,children:[e.jsx(v,{variant:"h3",children:"Restablecer Contraseña"}),e.jsx(v,{color:"secondary",children:"Establezca una nueva contraseña"})]})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(se,{})})]})})}export{ue as default};
