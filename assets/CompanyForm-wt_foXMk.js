import{w as H,y as J,r as u,j as r,G as i,D as K,E as $,F as E,k as O,H as Q,J as X,K as N,S as Z,a2 as W,a3 as _,P as S,ay as p}from"./index-pwr-e4Ht.js";import{u as ee,C as j}from"./index.esm-B6J6p8Kq.js";import{g as re,b as te,i as ae}from"./companies-DDk-XUBx.js";import{u as se}from"./useFormErrorRecovery-BnbLE14Q.js";import{T as w}from"./TextField-ChEHFDDT.js";import{I as oe}from"./InputLabel-BRdiyk76.js";import{C as ie}from"./CircularProgress-JbuhKxWk.js";const I=(t,o,m)=>(t==null?void 0:t[o])??(t==null?void 0:t[m])??"",ne=t=>(t==null?void 0:t.id)??(t==null?void 0:t.companyId)??null;function le({company:t=null,isEdit:o=!1,refreshCompanies:m=null}){const A=H(),{selectedCompany:n,setCompany:D}=J(),[C,q]=u.useState(!1),[L,F]=u.useState(!1),[P,z]=u.useState(null),{saveErrorWithFormData:B,getRecoveredData:k,clearRecoveredData:f}=se(`company-form-${o?t==null?void 0:t.id:"create"}`,P),{control:x,handleSubmit:G,reset:b,watch:V,formState:{errors:h}}=ee({defaultValues:{code:"",name:"",image:"",isActive:!0}}),R=V();u.useEffect(()=>{z(R)},[R]),u.useEffect(()=>{if(t&&o)b({code:I(t,"code","companyCode"),name:I(t,"name","companyName"),image:I(t,"image","imageUrl"),isActive:t.isActive??t.active??!0});else{const e=k();e&&(F(!0),b(e))}},[t,o,b,k]);const y=(e,a)=>e?e.length>10?(p("El codigo no puede exceder 10 caracteres"),!1):e!==e.toUpperCase()?(p("El codigo debe estar en mayuscula"),!1):a?!0:(p("El nombre es requerido"),!1):(p("El codigo es requerido"),!1),v=async e=>{var g,T;const a=(g=e.code)==null?void 0:g.trim().toUpperCase(),c=(T=e.name)==null?void 0:T.trim();if(y(a,c)){q(!0);try{const s=await re(a),d={code:a,name:c,image:e.image||null,isActive:e.isActive};if(o&&t){const l=ne(t);if(!l)throw new Error("No se pudo identificar la compañia");const U=(s==null?void 0:s.id)??(s==null?void 0:s.companyId)??null;if(U&&U!==l)throw new Error("Ya existe una compañia con este codigo");if(await te({...d,id:l,companyId:l}),W("Compañia actualizada exitosamente"),f(),((n==null?void 0:n.companyId)??(n==null?void 0:n.id))===l&&D){const Y={companyId:l,companyCode:a,companyName:c,imageUrl:e.image||null,active:e.isActive};D(Y)}}else{if(s)throw new Error("Ya existe una compañia con este codigo");await ae(d),W("Compañia creada exitosamente"),f()}m&&await m(),A("/apps/companies/list")}catch(s){const d=s.message||"Error al guardar la compañia";B(d,e,o?"update":"insert",()=>v(e)),_(d,()=>v(e),s.details||null)}finally{q(!1)}}},M=()=>{A("/apps/companies/list")};return r.jsx("form",{onSubmit:G(v),children:r.jsxs(i,{container:!0,spacing:3,children:[r.jsx(i,{item:!0,xs:12,children:r.jsx(K,{in:L,children:r.jsxs($,{severity:"info",onClose:()=>{F(!1),f()},sx:{mb:2},children:["Se detectaron datos guardados de un intento anterior. Los datos han sido restaurados. Puedes continuar editando o",r.jsx(E,{size:"small",sx:{ml:1},onClick:f,children:"Limpiar"})]})})}),r.jsx(i,{item:!0,xs:12,children:r.jsx(O,{variant:"h5",gutterBottom:!0,children:"Informacion general"})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(j,{name:"code",control:x,rules:{required:"El codigo es requerido",validate:e=>e!=null&&e.trim()?e.length>10?"El codigo no puede exceder 10 caracteres":e!==e.toUpperCase()?"El codigo debe estar en mayuscula":!0:"El codigo es requerido"},render:({field:e})=>{var a;return r.jsx(w,{...e,fullWidth:!0,label:"Codigo *",error:!!h.code,helperText:(a=h.code)==null?void 0:a.message,disabled:o,onChange:c=>{const g=c.target.value.toUpperCase();e.onChange(g.slice(0,10))}})}})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(j,{name:"name",control:x,rules:{required:"El nombre es requerido",validate:e=>e!=null&&e.trim()?!0:"El nombre es requerido"},render:({field:e})=>{var a;return r.jsx(w,{...e,fullWidth:!0,label:"Nombre *",error:!!h.name,helperText:(a=h.name)==null?void 0:a.message})}})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(j,{name:"image",control:x,render:({field:e})=>r.jsx(w,{...e,fullWidth:!0,label:"Imagen (URL)"})})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(j,{name:"isActive",control:x,render:({field:e})=>r.jsxs(Q,{fullWidth:!0,children:[r.jsx(oe,{children:"Estado"}),r.jsxs(X,{...e,label:"Estado",value:e.value?"true":"false",onChange:a=>e.onChange(a.target.value==="true"),children:[r.jsx(N,{value:"true",children:"Activa"}),r.jsx(N,{value:"false",children:"Inactiva"})]})]})})}),r.jsx(i,{item:!0,xs:12,children:r.jsxs(Z,{direction:"row",spacing:2,justifyContent:"flex-end",children:[r.jsx(E,{variant:"outlined",color:"inherit",onClick:M,disabled:C,children:"Cancelar"}),r.jsx(E,{type:"submit",variant:"contained",disabled:C,startIcon:C?r.jsx(ie,{size:16}):null,children:o?"Actualizar":"Guardar"})]})})]})})}le.propTypes={company:S.object,isEdit:S.bool,refreshCompanies:S.func};export{le as C};
