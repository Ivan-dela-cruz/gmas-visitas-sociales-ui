import{w as ve,R as Q,r as h,j as e,G as d,D as Ce,E as we,F as N,k as c,H as M,J as H,K as k,X as R,an as ye,ao as Se,B as q,S as L,O as ee,Z as se,$ as ae,a0 as re,C as ne,a1 as te,Q as ie,P as B,ay as _,a2 as G,a3 as K,U as oe,V as le,W as de,Y as ce,A as P}from"./index-C1pIq2vl.js";import{u as Ae,C as I}from"./index.esm-Gj4MCmXn.js";import{c as Ne,i as Ee,e as De}from"./users-DtXYsbxr.js";import{u as me,a as xe,b as ue}from"./usersCompanies-BMb0ImBJ.js";import{u as he}from"./companies-DTLzMQ5m.js";import{u as Ie}from"./useFormErrorRecovery-DfSn2Bs0.js";import{T}from"./TextField-BpgFI3H7.js";import{I as O}from"./InputLabel-Bx_DgBK8.js";import{F as Pe}from"./FormHelperText-DKDoT4uR.js";import{C as z}from"./CircularProgress-DEhu9n-n.js";import{T as ge,u as Te,C as Le}from"./useConfirmDialog-Brskm5sG.js";const je=({user:r=null,isEdit:t=!1,refreshUsers:i=null})=>{const x=ve(),[g,u]=Q.useState(!1),[j,m]=h.useState(""),[y,v]=h.useState(!1),[C,S]=h.useState(!1),[E,U]=h.useState(null),{saveErrorWithFormData:o,getRecoveredData:F,clearRecoveredData:W}=Ie(`user-form-${t?r==null?void 0:r.id:"create"}`,E),{userCompanies:p,userCompaniesLoading:n,mutateUserCompanies:f}=me(t&&r?r.id:null),{companies:l,companiesLoading:A}=he(),{control:D,handleSubmit:pe,reset:V,watch:fe,formState:{errors:b}}=Ae({defaultValues:{userName:"",email:"",fullName:"",password:"",confirmPassword:"",role:"User",isActive:!0}}),X=fe();h.useEffect(()=>{U(X)},[X]),h.useEffect(()=>{if(r&&t)V({userName:r.userName||"",email:r.email||"",fullName:r.fullName||"",role:r.role||"User",isActive:r.isActive??!0,password:"",confirmPassword:""});else{const s=F();s&&(S(!0),V(s))}},[r,t,V,F]);const J=async s=>{if(!t){if(!s.password){_("La contraseña es requerida");return}if(s.password!==s.confirmPassword){_("Las contraseñas no coinciden");return}}u(!0);try{const a={userName:s.userName,email:s.email,fullName:s.fullName,role:s.role,isActive:s.isActive};t||(a.password=s.password),t&&r?(await Ne({...a,id:r.id}),G("Usuario actualizado exitosamente"),W()):(await Ee(a),G("Usuario creado exitosamente"),W()),i&&await i(),x("/apps/users/list")}catch(a){const $=a.message||"Error al guardar el usuario";o($,s,t?"update":"insert",()=>J(s)),K($,()=>J(s),a.details||null)}finally{u(!1)}},be=()=>{x("/apps/users/list")},w=Q.useMemo(()=>{if(!l||!p)return l||[];const s=p.map(a=>a.companyId);return l.filter(a=>!s.includes(a.id))},[l,p]),Y=async()=>{if(!(!j||!r)){v(!0);try{await xe(r.id,j),await f(),m(""),G("Empresa asignada exitosamente")}catch(s){K("Error al asignar la empresa",()=>Y(),s.details||null)}finally{v(!1)}}},Z=async s=>{if(r&&window.confirm("¿Está seguro de desasignar esta empresa del usuario?"))try{await ue(s,r.id),await f(),G("Empresa desasignada exitosamente")}catch(a){K("Error al desasignar la empresa",()=>Z(s),a.details||null)}};return e.jsx("form",{onSubmit:pe(J),children:e.jsxs(d,{container:!0,spacing:3,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(Ce,{in:C,children:e.jsxs(we,{severity:"info",onClose:()=>{S(!1),W()},sx:{mb:2},children:["Se detectaron datos guardados de un intento anterior. Los datos han sido restaurados. Puedes continuar editando o",e.jsx(N,{size:"small",sx:{ml:1},onClick:W,children:"Limpiar"})]})})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,children:"Información general"})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"userName",control:D,rules:{required:"El nombre de usuario es requerido"},render:({field:s})=>{var a;return e.jsx(T,{...s,fullWidth:!0,label:"Nombre de Usuario *",error:!!b.userName,helperText:(a=b.userName)==null?void 0:a.message,disabled:t})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"fullName",control:D,rules:{required:"El nombre completo es requerido"},render:({field:s})=>{var a;return e.jsx(T,{...s,fullWidth:!0,label:"Nombre Completo *",error:!!b.fullName,helperText:(a=b.fullName)==null?void 0:a.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"email",control:D,rules:{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email inválido"}},render:({field:s})=>{var a;return e.jsx(T,{...s,fullWidth:!0,label:"Email *",type:"email",error:!!b.email,helperText:(a=b.email)==null?void 0:a.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"role",control:D,render:({field:s})=>e.jsxs(M,{fullWidth:!0,children:[e.jsx(O,{children:"Rol"}),e.jsxs(H,{...s,label:"Rol",children:[e.jsx(k,{value:"Admin",children:"Admin"}),e.jsx(k,{value:"User",children:"User"})]})]})})}),!t&&e.jsxs(e.Fragment,{children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,sx:{mt:2},children:"Contraseña"})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"password",control:D,rules:{required:t?!1:"La contraseña es requerida",minLength:{value:6,message:"Mínimo 6 caracteres"}},render:({field:s})=>{var a;return e.jsx(T,{...s,fullWidth:!0,label:"Contraseña *",type:"password",error:!!b.password,helperText:(a=b.password)==null?void 0:a.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"confirmPassword",control:D,rules:{required:t?!1:"Confirme la contraseña"},render:({field:s})=>{var a;return e.jsx(T,{...s,fullWidth:!0,label:"Confirmar Contraseña *",type:"password",error:!!b.confirmPassword,helperText:(a=b.confirmPassword)==null?void 0:a.message})}})})]}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(I,{name:"isActive",control:D,render:({field:s})=>e.jsxs(M,{fullWidth:!0,children:[e.jsx(O,{children:"Estado"}),e.jsxs(H,{...s,label:"Estado",value:s.value?"true":"false",onChange:a=>s.onChange(a.target.value==="true"),children:[e.jsx(k,{value:"true",children:"Activo"}),e.jsx(k,{value:"false",children:"Inactivo"})]})]})})}),t&&e.jsx(d,{item:!0,xs:12,children:e.jsx(Pe,{children:'Nota: Para cambiar la contraseña, use la opción "Cambiar Contraseña" en la lista de usuarios'})}),t&&r&&e.jsxs(e.Fragment,{children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(R,{sx:{my:2}})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,children:"Empresas Asignadas"})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(ye,{variant:"outlined",children:e.jsxs(Se,{children:[e.jsxs(q,{sx:{mb:3},children:[e.jsx(c,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:"Asignar Nueva Empresa"}),e.jsxs(L,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(M,{fullWidth:!0,sx:{maxWidth:400},children:[e.jsx(O,{children:"Seleccione Empresa"}),e.jsx(H,{value:j,onChange:s=>m(s.target.value),label:"Seleccione Empresa",disabled:A||y||!(w!=null&&w.length),children:w==null?void 0:w.map(s=>e.jsxs(k,{value:s.id,children:[s.code," - ",s.name]},s.id))})]}),e.jsx(N,{variant:"contained",startIcon:y?e.jsx(z,{size:16}):e.jsx(ee,{}),onClick:Y,disabled:!j||y,children:"Asignar"})]}),!(w!=null&&w.length)&&!A&&e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Todas las empresas disponibles ya están asignadas"})]}),e.jsx(R,{sx:{my:2}}),e.jsxs(q,{children:[e.jsxs(c,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:["Empresas Asignadas (",(p==null?void 0:p.length)||0,")"]}),n?e.jsx(q,{sx:{display:"flex",justifyContent:"center",py:3},children:e.jsx(z,{})}):p&&p.length>0?e.jsx(se,{children:p.map(s=>{const a=l==null?void 0:l.find($=>$.id===s.companyId);return e.jsxs(ae,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(re,{primary:e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ne,{label:(a==null?void 0:a.code)||s.companyId,size:"small",color:"primary"}),e.jsx(c,{variant:"subtitle2",children:(a==null?void 0:a.name)||"Empresa"})]}),secondary:s.assignedAt?`Asignada el: ${new Date(s.assignedAt).toLocaleDateString("es-ES")}`:null}),e.jsx(te,{children:e.jsx(ie,{edge:"end",color:"error",onClick:()=>Z(s.id),children:e.jsx(ge,{size:18})})})]},s.id)})}):e.jsx(c,{variant:"body2",color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No hay empresas asignadas a este usuario"})]})]})})})]}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(L,{direction:"row",spacing:2,justifyContent:"flex-end",sx:{mt:3},children:[e.jsx(N,{variant:"outlined",color:"secondary",onClick:be,disabled:g,children:"Cancelar"}),e.jsx(N,{variant:"contained",type:"submit",disabled:g,children:g?e.jsx(z,{size:24}):t?"Actualizar":"Guardar"})]})})]})})};je.propTypes={user:B.object,isEdit:B.bool,refreshUsers:B.func};const Ve=je,Ue=({open:r,onClose:t,user:i})=>{const[x,g]=h.useState(!1),[u,j]=h.useState(""),[m,y]=h.useState(""),[v,C]=h.useState({}),S=()=>{j(""),y(""),C({}),t()},E=()=>{const o={};return u?u.length<8&&(o.newPassword="La contraseña debe tener al menos 8 caracteres"):o.newPassword="La contraseña es requerida",m?u!==m&&(o.confirmPassword="Las contraseñas no coinciden"):o.confirmPassword="Confirme la contraseña",C(o),Object.keys(o).length===0},U=async()=>{if(E()){g(!0);try{await De(i.userName,u),P({open:!0,message:"Contraseña cambiada exitosamente",variant:"alert",alert:{color:"success"}}),S()}catch(o){P({open:!0,message:o.message||"Error al cambiar la contraseña",variant:"alert",alert:{color:"error"}})}finally{g(!1)}}};return e.jsxs(oe,{open:r,onClose:S,maxWidth:"sm",fullWidth:!0,children:[e.jsx(le,{children:"Cambiar Contraseña"}),e.jsx(de,{children:e.jsxs(L,{spacing:2,sx:{mt:2},children:[e.jsxs(c,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})]}),e.jsx(T,{fullWidth:!0,label:"Nueva Contraseña",type:"password",value:u,onChange:o=>j(o.target.value),error:!!v.newPassword,helperText:v.newPassword,disabled:x}),e.jsx(T,{fullWidth:!0,label:"Confirmar Contraseña",type:"password",value:m,onChange:o=>y(o.target.value),error:!!v.confirmPassword,helperText:v.confirmPassword,disabled:x})]})}),e.jsxs(ce,{children:[e.jsx(N,{onClick:S,disabled:x,children:"Cancelar"}),e.jsx(N,{variant:"contained",onClick:U,disabled:x,children:x?e.jsx(z,{size:24}):"Cambiar Contraseña"})]})]})},Je=Ue,We=({open:r,onClose:t,user:i})=>{const[x,g]=h.useState(!1),[u,j]=h.useState(""),{dialogState:m,openDialog:y,closeDialog:v}=Te(),{userCompanies:C,userCompaniesLoading:S}=me(i==null?void 0:i.id),{companies:E,companiesLoading:U}=he(),o=()=>{j(""),t()},F=E.filter(n=>!C.some(f=>f.companyId===n.id)),W=async()=>{if(!u){P({open:!0,message:"Seleccione una empresa",variant:"alert",alert:{color:"warning"}});return}g(!0);try{await xe(i.id,u),P({open:!0,message:"Empresa asignada exitosamente",variant:"alert",alert:{color:"success"}}),j("")}catch(n){P({open:!0,message:n.message||"Error al asignar empresa",variant:"alert",alert:{color:"error"}})}finally{g(!1)}},p=async n=>{const f=E.find(A=>A.id===n.companyId),l=(f==null?void 0:f.name)||n.companyName||"esta empresa";y({title:"Desasignar Empresa",message:`¿Está seguro de desasignar la empresa "${l}"?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{g(!0);try{await ue(n.id,i.id),P({open:!0,message:"Empresa desasignada exitosamente",variant:"alert",alert:{color:"success"}})}catch(A){P({open:!0,message:A.message||"Error al desasignar empresa",variant:"alert",alert:{color:"error"}})}finally{g(!1)}}})};return e.jsxs(oe,{open:r,onClose:o,maxWidth:"md",fullWidth:!0,children:[e.jsx(le,{children:"Asignar Empresas"}),e.jsx(de,{children:e.jsxs(L,{spacing:3,sx:{mt:1},children:[e.jsxs(c,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})," (",i==null?void 0:i.fullName,")"]}),e.jsx(R,{}),e.jsxs(q,{children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:"Asignar Nueva Empresa"}),e.jsxs(L,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsxs(M,{fullWidth:!0,disabled:U||x,children:[e.jsx(O,{children:"Seleccionar Empresa"}),e.jsx(H,{value:u,onChange:n=>j(n.target.value),label:"Seleccionar Empresa",children:F.map(n=>e.jsxs(k,{value:n.id,children:[n.code," - ",n.name]},n.id))})]}),e.jsx(N,{variant:"contained",startIcon:e.jsx(ee,{}),onClick:W,disabled:x||!u,children:"Asignar"})]}),F.length===0&&!U&&e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"No hay empresas disponibles para asignar"})]}),e.jsx(R,{}),e.jsxs(q,{children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:"Empresas Asignadas"}),S?e.jsx(z,{}):C.length===0?e.jsx(c,{variant:"body2",color:"text.secondary",children:"No hay empresas asignadas"}):e.jsx(se,{children:C.map((n,f)=>{const l=E.find(A=>A.id===n.companyId);return e.jsxs(Q.Fragment,{children:[e.jsxs(ae,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(re,{primary:e.jsxs(L,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ne,{label:(l==null?void 0:l.code)||"N/A",size:"small",color:"primary"}),e.jsx(c,{variant:"subtitle2",children:(l==null?void 0:l.name)||"Empresa desconocida"})]}),secondary:`Asignada el: ${new Date(n.createdAt||Date.now()).toLocaleDateString("es-ES")}`}),e.jsx(te,{children:e.jsx(ie,{edge:"end",color:"error",onClick:()=>p(n),disabled:x,children:e.jsx(ge,{size:20})})})]}),f<C.length-1&&e.jsx(R,{})]},n.id)})})]})]})}),e.jsx(ce,{children:e.jsx(N,{onClick:o,disabled:x,children:"Cerrar"})}),e.jsx(Le,{open:m.open,title:m.title,message:m.message,onConfirm:m.onConfirm,onCancel:v,confirmText:m.confirmText,cancelText:m.cancelText,severity:m.severity})]})},Ke=We;B.object,B.func;export{Ke as A,Je as C,Ve as U};
