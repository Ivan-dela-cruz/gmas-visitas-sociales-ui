import{w as M,r as l,j as r,G as i,D as Y,E as H,F as v,k as J,H as K,J as $,K as T,S as O,a2 as U,a3 as Q,P as E,ay as g}from"./index-C1pIq2vl.js";import{u as X,C as p}from"./index.esm-Gj4MCmXn.js";import{g as Z,b as _,i as y}from"./companies-DTLzMQ5m.js";import{u as ee}from"./useFormErrorRecovery-DfSn2Bs0.js";import{T as S}from"./TextField-BpgFI3H7.js";import{I as re}from"./InputLabel-Bx_DgBK8.js";import{C as te}from"./CircularProgress-DEhu9n-n.js";const w=(t,o,c)=>(t==null?void 0:t[o])??(t==null?void 0:t[c])??"",ae=t=>(t==null?void 0:t.id)??(t==null?void 0:t.companyId)??null;function se({company:t=null,isEdit:o=!1,refreshCompanies:c=null}){const I=M(),[j,A]=l.useState(!1),[W,D]=l.useState(!1),[L,N]=l.useState(null),{saveErrorWithFormData:P,getRecoveredData:q,clearRecoveredData:d}=ee(`company-form-${o?t==null?void 0:t.id:"create"}`,L),{control:u,handleSubmit:z,reset:C,watch:B,formState:{errors:m}}=X({defaultValues:{code:"",name:"",image:"",isActive:!0}}),F=B();l.useEffect(()=>{N(F)},[F]),l.useEffect(()=>{if(t&&o)C({code:w(t,"code","companyCode"),name:w(t,"name","companyName"),image:w(t,"image","imageUrl"),isActive:t.isActive??t.active??!0});else{const e=q();e&&(D(!0),C(e))}},[t,o,C,q]);const G=(e,a)=>e?e.length>10?(g("El codigo no puede exceder 10 caracteres"),!1):e!==e.toUpperCase()?(g("El codigo debe estar en mayuscula"),!1):a?!0:(g("El nombre es requerido"),!1):(g("El codigo es requerido"),!1),b=async e=>{var x,k;const a=(x=e.code)==null?void 0:x.trim().toUpperCase(),f=(k=e.name)==null?void 0:k.trim();if(G(a,f)){A(!0);try{const s=await Z(a),n={code:a,name:f,image:e.image||null,isActive:e.isActive};if(o&&t){const h=ae(t);if(!h)throw new Error("No se pudo identificar la compañia");const R=(s==null?void 0:s.id)??(s==null?void 0:s.companyId)??null;if(R&&R!==h)throw new Error("Ya existe una compañia con este codigo");await _({...n,id:h,companyId:h}),U("Compañia actualizada exitosamente"),d()}else{if(s)throw new Error("Ya existe una compañia con este codigo");await y(n),U("Compañia creada exitosamente"),d()}c&&await c(),I("/apps/companies/list")}catch(s){const n=s.message||"Error al guardar la compañia";P(n,e,o?"update":"insert",()=>b(e)),Q(n,()=>b(e),s.details||null)}finally{A(!1)}}},V=()=>{I("/apps/companies/list")};return r.jsx("form",{onSubmit:z(b),children:r.jsxs(i,{container:!0,spacing:3,children:[r.jsx(i,{item:!0,xs:12,children:r.jsx(Y,{in:W,children:r.jsxs(H,{severity:"info",onClose:()=>{D(!1),d()},sx:{mb:2},children:["Se detectaron datos guardados de un intento anterior. Los datos han sido restaurados. Puedes continuar editando o",r.jsx(v,{size:"small",sx:{ml:1},onClick:d,children:"Limpiar"})]})})}),r.jsx(i,{item:!0,xs:12,children:r.jsx(J,{variant:"h5",gutterBottom:!0,children:"Informacion general"})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(p,{name:"code",control:u,rules:{required:"El codigo es requerido",validate:e=>e!=null&&e.trim()?e.length>10?"El codigo no puede exceder 10 caracteres":e!==e.toUpperCase()?"El codigo debe estar en mayuscula":!0:"El codigo es requerido"},render:({field:e})=>{var a;return r.jsx(S,{...e,fullWidth:!0,label:"Codigo *",error:!!m.code,helperText:(a=m.code)==null?void 0:a.message,onChange:f=>{const x=f.target.value.toUpperCase();e.onChange(x.slice(0,10))}})}})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(p,{name:"name",control:u,rules:{required:"El nombre es requerido",validate:e=>e!=null&&e.trim()?!0:"El nombre es requerido"},render:({field:e})=>{var a;return r.jsx(S,{...e,fullWidth:!0,label:"Nombre *",error:!!m.name,helperText:(a=m.name)==null?void 0:a.message})}})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(p,{name:"image",control:u,render:({field:e})=>r.jsx(S,{...e,fullWidth:!0,label:"Imagen (URL)"})})}),r.jsx(i,{item:!0,xs:12,sm:6,children:r.jsx(p,{name:"isActive",control:u,render:({field:e})=>r.jsxs(K,{fullWidth:!0,children:[r.jsx(re,{children:"Estado"}),r.jsxs($,{...e,label:"Estado",value:e.value?"true":"false",onChange:a=>e.onChange(a.target.value==="true"),children:[r.jsx(T,{value:"true",children:"Activa"}),r.jsx(T,{value:"false",children:"Inactiva"})]})]})})}),r.jsx(i,{item:!0,xs:12,children:r.jsxs(O,{direction:"row",spacing:2,justifyContent:"flex-end",children:[r.jsx(v,{variant:"outlined",color:"inherit",onClick:V,disabled:j,children:"Cancelar"}),r.jsx(v,{type:"submit",variant:"contained",disabled:j,startIcon:j?r.jsx(te,{size:16}):null,children:o?"Actualizar":"Guardar"})]})})]})})}se.propTypes={company:E.object,isEdit:E.bool,refreshCompanies:E.func};export{se as C};
