import{w as fe,N as je,y as be,r as t,j as e,C as u,k as i,B as n,S as r,M as V,D as Ce,E as Se,F as L,O,X as R,H as ve,J as Ee,K as P,Z as Ae,R as Ie,$ as Ne,a0 as we,a1 as Ge,Q as ke,a2 as S,a3 as v}from"./index-CMlrmw9_.js";import{u as Ve}from"./index.esm-Ds7NXHRL.js";import{B as M}from"./index-DhC-z79l.js";import{a as Le,b as Re}from"./companyVisitGroups-yotrs--f.js";import{u as Te,a as De,d as Ue,b as Fe,c as ze,e as He,f as Ke}from"./userCompanyVisitGroups-BcAyc7mL.js";import{u as Be}from"./users-DNhK1xWS.js";import{C as Oe}from"./CompanyVisitGroupForm-8Im4_jFu.js";import{u as Pe,T as W,C as Me}from"./useConfirmDialog-CW-ri43z.js";import{u as We,a as $e}from"./useFormLifecycle-C2gz9Zyk.js";import{C as E}from"./Checkbox-ClaEhg--.js";import{C as h}from"./CircularProgress-C4wVOatm.js";import{I as Je}from"./InputLabel-BcyW2Dv4.js";import"./ArrowLeft-A6bVVC6K.js";import"./TextField-B_-UPyso.js";import"./FormHelperText-CoFCbm6G.js";import"./Switch-zFeR6mAA.js";import"./useFormErrorRecovery-CyeekJOu.js";function ms(){const T=fe(),{id:l}=je(),{selectedCompany:A}=be(),[$,D]=t.useState(!1),[x,c]=t.useState(!1),[m,U]=t.useState({}),[p,F]=t.useState({}),[f,z]=t.useState(""),{dialogState:g,openDialog:H,closeDialog:J}=Pe(),{companyVisitGroup:d,companyVisitGroupLoading:Q,companyVisitGroupError:X}=Le(l),{employeeCompanies:Z,employeeCompaniesLoading:q}=Te(A==null?void 0:A.companyId),{employeeCompanyVisitGroups:I,employeeCompanyVisitGroupsLoading:Y,refreshEmployeeCompanyVisitGroups:j}=De(l),{users:K,usersLoading:_}=Be(),{userCompanyVisitGroups:y,userCompanyVisitGroupsLoading:ee,refreshUserCompanyVisitGroups:b}=Ue(l),{control:se,handleSubmit:ae,reset:N,watch:oe,formState:{errors:ie}}=Ve({defaultValues:{code:"",name:"",description:"",status:!0}}),ne=oe(),{handleError:te,handleSuccess:re,handleWarning:w}=We("companyVisitGroup-form",{onSuccess:()=>{T("/apps/visits/groups/list")}}),{showRecoveryAlert:le,clearRecoveredData:B,onSuccessSubmit:ce}=$e(`companyVisitGroup-form-${l}`,ne,N,!0);t.useEffect(()=>{d&&N({code:d.code||"",name:d.name||"",description:d.description||"",status:d.status??!0})},[d,N]);const de=async s=>{D(!0);try{const a={id:d.id,...s,companyId:d.companyId};await Re(a),re("Grupo actualizado exitosamente"),ce()}catch(a){te(a,s,"update")}finally{D(!1)}},me=()=>{T("/apps/visits/groups/list")},G=Z.filter(s=>!I.some(a=>a.employeeCompanyId===s.id)),pe=t.useMemo(()=>[{id:"select",header:({table:s})=>e.jsx(E,{checked:s.getIsAllPageRowsSelected(),indeterminate:s.getIsSomePageRowsSelected(),onChange:a=>{s.getToggleAllPageRowsSelectedHandler()(a)},sx:{padding:0}}),cell:({row:s})=>e.jsx(E,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onChange:a=>{s.getToggleSelectedHandler()(a)},sx:{padding:0}}),enableColumnFilter:!1,enableSorting:!1,enableHiding:!1,size:50,meta:{skipFilter:!0}},{header:"Código",accessorKey:"codeEmployee",cell:({getValue:s})=>e.jsx(u,{label:s()||"N/A",size:"small",color:"primary",variant:"light"}),size:100},{header:"Identificación",accessorKey:"employeeIdentification",cell:({getValue:s})=>e.jsx(i,{variant:"body2",children:s()||"N/A"})},{header:"Nombres",accessorKey:"employeeFirstName",cell:({getValue:s})=>e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:s()||"N/A"})},{header:"Apellidos",accessorKey:"employeeLastName",cell:({getValue:s})=>e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:s()||"N/A"})},{header:"Estado",accessorKey:"status",cell:({getValue:s})=>e.jsx(u,{label:s()?"Activo":"Inactivo",color:s()?"success":"error",size:"small",variant:"light"}),size:100}],[]),ge=t.useMemo(()=>[{id:"select",header:({table:s})=>e.jsx(E,{checked:s.getIsAllPageRowsSelected(),indeterminate:s.getIsSomePageRowsSelected(),onChange:a=>{s.getToggleAllPageRowsSelectedHandler()(a)},sx:{padding:0}}),cell:({row:s})=>e.jsx(E,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onChange:a=>{s.getToggleSelectedHandler()(a)},sx:{padding:0}}),enableColumnFilter:!1,enableSorting:!1,enableHiding:!1,size:50,meta:{skipFilter:!0}},{header:"Código",accessorKey:"employeeCompany.codeEmployee",cell:({row:s})=>{var a;return e.jsx(u,{label:((a=s.original.employeeCompany)==null?void 0:a.codeEmployee)||"N/A",size:"small",color:"primary"})},size:100},{header:"Identificación",accessorKey:"employeeCompany.employeeIdentification",cell:({row:s})=>{var a,o,C;return e.jsx(i,{variant:"body2",children:((a=s.original.employeeCompany)==null?void 0:a.employeeIdentification)||((C=(o=s.original.employeeCompany)==null?void 0:o.employee)==null?void 0:C.identification)||"N/A"})}},{header:"Nombres",accessorKey:"employeeCompany.employeeFirstName",cell:({row:s})=>{var a;return e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:((a=s.original.employeeCompany)==null?void 0:a.employeeFirstName)||"N/A"})}},{header:"Apellidos",accessorKey:"employeeCompany.employeeLastName",cell:({row:s})=>{var a;return e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:((a=s.original.employeeCompany)==null?void 0:a.employeeLastName)||"N/A"})}},{header:"Teléfono",accessorKey:"employeeCompany.employee.cellphoneNumber",cell:({row:s})=>{var a,o;return e.jsx(i,{variant:"body2",children:((o=(a=s.original.employeeCompany)==null?void 0:a.employee)==null?void 0:o.cellphoneNumber)||"N/A"})}},{header:"Fecha Asignación",accessorKey:"createdAt",cell:({getValue:s})=>{const a=s();return a?new Date(a).toLocaleDateString("es-ES"):"N/A"},size:120}],[]),ue=async()=>{const s=Object.keys(m).filter(a=>m[a]);if(s.length===0){w("Seleccione al menos un empleado");return}c(!0);try{await Fe(s,l),S(`${s.length} empleado(s) asignado(s) exitosamente`),U({}),j&&j()}catch(a){v(a.message||"Error al asignar empleados")}finally{c(!1)}},ye=async()=>{const s=Object.keys(p).filter(a=>p[a]);if(s.length===0){w("Seleccione al menos un empleado");return}H({title:"Desasignar Empleados",message:`¿Está seguro de desasignar ${s.length} empleado(s)?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{c(!0);try{await ze(s,l),S(`${s.length} empleado(s) desasignado(s) exitosamente`),F({}),j&&j()}catch(a){v(a.message||"Error al desasignar empleados")}finally{c(!1)}}})},k=t.useMemo(()=>K.filter(s=>!y.some(a=>a.userId===s.id)),[K,y]),he=async()=>{if(!f){w("Seleccione un usuario");return}c(!0);try{await He(f,l),S("Usuario asignado exitosamente"),z(""),b&&b()}catch(s){v(s.message||"Error al asignar usuario")}finally{c(!1)}},xe=s=>{const a=s.user,o=(a==null?void 0:a.fullName)||(a==null?void 0:a.userName)||"este usuario";H({title:"Desasignar Usuario",message:`¿Está seguro de desasignar al usuario "${o}"?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{c(!0);try{await Ke(s.id,l),S("Usuario desasignado exitosamente"),b&&b()}catch(C){v(C.message||"Error al desasignar usuario")}finally{c(!1)}}})};return Q?e.jsx(n,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(h,{})}):X?e.jsx(n,{sx:{p:3},children:e.jsx(i,{color:"error",children:"Error al cargar el grupo"})}):e.jsxs(e.Fragment,{children:[e.jsxs(r,{spacing:3,children:[e.jsx(V,{title:"Editar Grupo de Visitas",children:e.jsxs(r,{spacing:3,children:[e.jsx(Ce,{in:le,children:e.jsxs(Se,{severity:"info",onClose:()=>B(),children:["Se detectaron datos guardados de un intento anterior. Los datos han sido restaurados. Puedes continuar editando o",e.jsx(L,{size:"small",sx:{ml:1},onClick:B,children:"Limpiar"})]})}),e.jsx(Oe,{control:se,handleSubmit:ae,onSubmit:de,loading:$,onCancel:me,errors:ie,isEdit:!0})]})}),e.jsx(V,{title:"Empleados Asignados",children:e.jsxs(r,{spacing:3,children:[e.jsxs(n,{children:[e.jsxs(r,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(i,{variant:"h6",children:["Empleados Disponibles (",G.length,")"]}),e.jsxs(L,{variant:"contained",startIcon:e.jsx(O,{}),onClick:ue,disabled:x||Object.keys(m).filter(s=>m[s]).length===0,children:["Asignar Seleccionados (",Object.keys(m).filter(s=>m[s]).length,")"]})]}),q?e.jsx(n,{display:"flex",justifyContent:"center",p:3,children:e.jsx(h,{})}):G.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"No hay empleados disponibles para asignar"}):e.jsx(n,{sx:{maxHeight:400,overflow:"auto"},children:e.jsx(M,{data:G,columns:pe,enableRowSelection:!0,filterOnHeaderVisible:!0,tableId:"assignEmployeesEditTable",onRowSelectionChange:U,rowSelection:m})})]}),e.jsx(R,{}),e.jsx(n,{children:Y?e.jsx(n,{display:"flex",justifyContent:"center",p:3,children:e.jsx(h,{})}):I.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"No hay empleados asignados a este grupo"}):e.jsx(n,{sx:{maxHeight:400,overflow:"auto"},children:e.jsx(M,{title:"Empleados Asignados",toolbarButtons:[{label:`Desasignar Seleccionados (${Object.keys(p).filter(s=>p[s]).length})`,icon:e.jsx(W,{}),toolTip:"Desasignar empleados seleccionados",variant:"contained",color:"error",onClick:ye,disabled:Object.keys(p).filter(s=>p[s]).length===0}],data:I,columns:ge,enableRowSelection:!0,filterOnHeaderVisible:!0,tableId:"assignedEmployeesEditTable",onRowSelectionChange:F,rowSelection:p,isDownload:!1})})})]})}),e.jsx(V,{title:"Usuarios Asignados",children:e.jsxs(r,{spacing:3,children:[e.jsxs(n,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Asignar Usuario"}),_?e.jsx(n,{display:"flex",justifyContent:"center",p:3,children:e.jsx(h,{})}):e.jsxs(r,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsxs(ve,{fullWidth:!0,children:[e.jsx(Je,{id:"select-user-label",children:"Usuario"}),e.jsx(Ee,{labelId:"select-user-label",id:"select-user",value:f,label:"Usuario",onChange:s=>z(s.target.value),disabled:x||k.length===0,children:k.length===0?e.jsx(P,{value:"",children:e.jsx("em",{children:"No hay usuarios disponibles"})}):k.map(s=>e.jsx(P,{value:s.id,children:e.jsxs(r,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(i,{children:s.fullName||s.userName}),e.jsx(u,{label:s.email,size:"small",variant:"outlined"}),e.jsx(u,{label:s.role,size:"small",color:s.role==="Admin"?"primary":"default",variant:"light"})]})},s.id))})]}),e.jsx(L,{variant:"contained",startIcon:e.jsx(O,{}),onClick:he,disabled:x||!f,sx:{minWidth:120},children:"Asignar"})]})]}),e.jsx(R,{}),e.jsxs(n,{children:[e.jsxs(i,{variant:"h6",gutterBottom:!0,children:["Lista de Usuarios (",y.length,")"]}),ee?e.jsx(n,{display:"flex",justifyContent:"center",p:3,children:e.jsx(h,{})}):y.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"No hay usuarios asignados a este grupo"}):e.jsx(Ae,{children:y.map((s,a)=>{const o=s.user;return e.jsxs(Ie.Fragment,{children:[e.jsxs(Ne,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(we,{primary:e.jsxs(r,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(i,{variant:"subtitle2",children:(o==null?void 0:o.fullName)||(o==null?void 0:o.userName)}),e.jsx(u,{label:o==null?void 0:o.email,size:"small",variant:"outlined"}),e.jsx(u,{label:o==null?void 0:o.role,size:"small",color:(o==null?void 0:o.role)==="Admin"?"primary":"default",variant:"light"})]}),secondary:e.jsxs(r,{spacing:.5,sx:{mt:.5},children:[e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Estado: ",o!=null&&o.isActive?"Activo":"Inactivo"]}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Asignado el: ",new Date(s.createdAt).toLocaleDateString("es-ES")]})]})}),e.jsx(Ge,{children:e.jsx(ke,{edge:"end",color:"error",onClick:()=>xe(s),disabled:x,children:e.jsx(W,{size:20})})})]}),a<y.length-1&&e.jsx(R,{})]},s.id)})})]})]})})]}),e.jsx(Me,{open:g.open,title:g.title,message:g.message,onConfirm:g.onConfirm,onCancel:J,confirmText:g.confirmText,cancelText:g.cancelText,severity:g.severity})]})}export{ms as default};
