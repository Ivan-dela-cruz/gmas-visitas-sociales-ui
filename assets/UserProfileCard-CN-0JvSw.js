import{w as Se,R as K,r as p,j as e,G as d,D as Ee,E as Ie,F as E,k as c,H as M,J as O,K as k,X as F,an as Ue,ao as Pe,B as q,S as D,O as re,Z as ne,$ as te,a0 as ie,C as oe,a1 as le,Q as de,P as z,ay as se,a2 as G,a3 as J,U as ce,V as me,W as xe,Y as ue,A as T}from"./index-pwr-e4Ht.js";import{u as Te,C as P}from"./index.esm-B6J6p8Kq.js";import{c as Le,i as De,e as Re}from"./users-DWxc2WmK.js";import{u as he,a as ge,b as pe}from"./usersCompanies-D77p7jC4.js";import{u as je}from"./companies-DDk-XUBx.js";import{u as We}from"./useFormErrorRecovery-BnbLE14Q.js";import{T as L}from"./TextField-ChEHFDDT.js";import{I as V}from"./InputLabel-BRdiyk76.js";import{F as ke}from"./FormHelperText-vhUhcK_2.js";import{C as $}from"./CircularProgress-JbuhKxWk.js";import{T as fe,u as Be,C as Fe}from"./useConfirmDialog-B93jbB1J.js";const Ce=({user:s=null,isEdit:t=!1,refreshUsers:i=null})=>{const u=Se(),[j,h]=K.useState(!1),[f,m]=p.useState(""),[A,b]=p.useState(!1),[y,N]=p.useState(!1),[I,R]=p.useState(null),{saveErrorWithFormData:o,getRecoveredData:B,clearRecoveredData:W}=We(`user-form-${t?s==null?void 0:s.id:"create"}`,I),{userCompanies:g,userCompaniesLoading:n,mutateUserCompanies:C}=he(t&&s?s.id:null),{companies:l,companiesLoading:S}=je(),{control:U,handleSubmit:ve,reset:H,watch:be,formState:{errors:v}}=Te({defaultValues:{userName:"",email:"",fullName:"",password:"",confirmPassword:"",role:"User",isActive:!0}}),Q=be();p.useEffect(()=>{R(Q)},[Q]),p.useEffect(()=>{if(s&&t)H({userName:s.userName||"",email:s.email||"",fullName:s.fullName||"",role:s.role||"User",isActive:s.isActive??!0,password:"",confirmPassword:""});else{const a=B();a&&(N(!0),H(a))}},[s,t,H,B]);const ye=()=>Array.isArray(g)?g.map(a=>({...a,userId:a.userId??(s==null?void 0:s.id),userName:a.userName??(s==null?void 0:s.userName)})):Array.isArray(s==null?void 0:s.companies)?s.companies:[],we=a=>{const r=new Date().toISOString(),x=(s==null?void 0:s.userName)||a.userName||"";return{...s,createdAt:(s==null?void 0:s.createdAt)||r,updatedAt:r,userCreatedBy:(s==null?void 0:s.userCreatedBy)||x,userUpdatedBy:(s==null?void 0:s.userUpdatedBy)||x,id:s==null?void 0:s.id,userName:a.userName,email:a.email,fullName:a.fullName,role:a.role,isActive:a.isActive,lastLogin:(s==null?void 0:s.lastLogin)||r,companies:ye()}},Ae=a=>{var x,Z,ee,ae;const r=[a==null?void 0:a.message,a==null?void 0:a.statusCode,(Z=(x=a==null?void 0:a.response)==null?void 0:x.data)==null?void 0:Z.message,(ae=(ee=a==null?void 0:a.response)==null?void 0:ee.data)==null?void 0:ae.statusCode,a==null?void 0:a.details].filter(Boolean).join(" ").toUpperCase();return r.includes("ERR019")||r.includes("INTERNAL_SERVER_ERROR")&&r.includes("CREATING THE USER")?"El nombre de usuario o el email ya están duplicados. Verifica e intenta nuevamente.":(a==null?void 0:a.message)||"Error al guardar el usuario"},_=async a=>{if(!t){if(!a.password){se("La contraseña es requerida");return}if(a.password!==a.confirmPassword){se("Las contraseñas no coinciden");return}}h(!0);try{const r={userName:(a.userName||"").toUpperCase(),email:a.email,fullName:a.fullName,role:a.role,isActive:a.isActive};if(t||(r.password=a.password),t&&s){const x=we(r);await Le(x),G("Usuario actualizado exitosamente"),W()}else await De(r),G("Usuario creado exitosamente"),W();i&&await i(),u("/apps/users/list")}catch(r){const x=Ae(r);o(x,a,t?"update":"insert",()=>_(a)),J(x,()=>_(a),r.details||null)}finally{h(!1)}},Ne=()=>{u("/apps/users/list")},w=K.useMemo(()=>{if(!l||!g)return l||[];const a=g.map(r=>r.companyId);return l.filter(r=>!a.includes(r.id))},[l,g]),X=async()=>{if(!(!f||!s)){b(!0);try{await ge(s.id,f),await C(),m(""),G("Empresa asignada exitosamente")}catch(a){J("Error al asignar la empresa",()=>X(),a.details||null)}finally{b(!1)}}},Y=async a=>{if(s&&window.confirm("¿Está seguro de desasignar esta empresa del usuario?"))try{await pe(a,s.id),await C(),G("Empresa desasignada exitosamente")}catch(r){J("Error al desasignar la empresa",()=>Y(a),r.details||null)}};return e.jsx("form",{onSubmit:ve(_),children:e.jsxs(d,{container:!0,spacing:3,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(Ee,{in:y,children:e.jsxs(Ie,{severity:"info",onClose:()=>{N(!1),W()},sx:{mb:2},children:["Se detectaron datos guardados de un intento anterior. Los datos han sido restaurados. Puedes continuar editando o",e.jsx(E,{size:"small",sx:{ml:1},onClick:W,children:"Limpiar"})]})})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,children:"Información general"})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"userName",control:U,rules:{required:"El nombre de usuario es requerido"},render:({field:a})=>{var r;return e.jsx(L,{...a,fullWidth:!0,label:"Nombre de Usuario *",error:!!v.userName,helperText:(r=v.userName)==null?void 0:r.message,disabled:t,value:(a.value||"").toUpperCase(),onChange:x=>a.onChange((x.target.value||"").toUpperCase())})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"fullName",control:U,rules:{required:"El nombre completo es requerido"},render:({field:a})=>{var r;return e.jsx(L,{...a,fullWidth:!0,label:"Nombre Completo *",error:!!v.fullName,helperText:(r=v.fullName)==null?void 0:r.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"email",control:U,rules:{required:"El email es requerido",pattern:{value:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,message:"Email inválido"}},render:({field:a})=>{var r;return e.jsx(L,{...a,fullWidth:!0,label:"Email *",type:"email",error:!!v.email,helperText:(r=v.email)==null?void 0:r.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"role",control:U,render:({field:a})=>e.jsxs(M,{fullWidth:!0,children:[e.jsx(V,{children:"Rol"}),e.jsxs(O,{...a,label:"Rol",children:[e.jsx(k,{value:"Admin",children:"Admin"}),e.jsx(k,{value:"User",children:"User"})]})]})})}),!t&&e.jsxs(e.Fragment,{children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,sx:{mt:2},children:"Contraseña"})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"password",control:U,rules:{required:t?!1:"La contraseña es requerida",minLength:{value:6,message:"Mínimo 6 caracteres"}},render:({field:a})=>{var r;return e.jsx(L,{...a,fullWidth:!0,label:"Contraseña *",type:"password",error:!!v.password,helperText:(r=v.password)==null?void 0:r.message})}})}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"confirmPassword",control:U,rules:{required:t?!1:"Confirme la contraseña"},render:({field:a})=>{var r;return e.jsx(L,{...a,fullWidth:!0,label:"Confirmar Contraseña *",type:"password",error:!!v.confirmPassword,helperText:(r=v.confirmPassword)==null?void 0:r.message})}})})]}),e.jsx(d,{item:!0,xs:12,sm:6,children:e.jsx(P,{name:"isActive",control:U,render:({field:a})=>e.jsxs(M,{fullWidth:!0,children:[e.jsx(V,{children:"Estado"}),e.jsxs(O,{...a,label:"Estado",value:a.value?"true":"false",onChange:r=>a.onChange(r.target.value==="true"),children:[e.jsx(k,{value:"true",children:"Activo"}),e.jsx(k,{value:"false",children:"Inactivo"})]})]})})}),t&&e.jsx(d,{item:!0,xs:12,children:e.jsx(ke,{children:'Nota: Para cambiar la contraseña, use la opción "Cambiar Contraseña" en la lista de usuarios'})}),t&&s&&e.jsxs(e.Fragment,{children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(F,{sx:{my:2}})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(c,{variant:"h5",gutterBottom:!0,children:"Empresas Asignadas"})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(Ue,{variant:"outlined",children:e.jsxs(Pe,{children:[e.jsxs(q,{sx:{mb:3},children:[e.jsx(c,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:"Asignar Nueva Empresa"}),e.jsxs(D,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(M,{fullWidth:!0,sx:{maxWidth:400},children:[e.jsx(V,{children:"Seleccione Empresa"}),e.jsx(O,{value:f,onChange:a=>m(a.target.value),label:"Seleccione Empresa",disabled:S||A||!(w!=null&&w.length),children:w==null?void 0:w.map(a=>e.jsxs(k,{value:a.id,children:[a.code," - ",a.name]},a.id))})]}),e.jsx(E,{variant:"contained",startIcon:A?e.jsx($,{size:16}):e.jsx(re,{}),onClick:X,disabled:!f||A,children:"Asignar"})]}),!(w!=null&&w.length)&&!S&&e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Todas las empresas disponibles ya están asignadas"})]}),e.jsx(F,{sx:{my:2}}),e.jsxs(q,{children:[e.jsxs(c,{variant:"subtitle1",gutterBottom:!0,sx:{mb:2},children:["Empresas Asignadas (",(g==null?void 0:g.length)||0,")"]}),n?e.jsx(q,{sx:{display:"flex",justifyContent:"center",py:3},children:e.jsx($,{})}):g&&g.length>0?e.jsx(ne,{children:g.map(a=>{const r=l==null?void 0:l.find(x=>x.id===a.companyId);return e.jsxs(te,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(ie,{primary:e.jsxs(D,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(oe,{label:(r==null?void 0:r.code)||a.companyId,size:"small",color:"primary"}),e.jsx(c,{variant:"subtitle2",children:(r==null?void 0:r.name)||"Empresa"})]}),secondary:a.assignedAt?`Asignada el: ${new Date(a.assignedAt).toLocaleDateString("es-ES")}`:null}),e.jsx(le,{children:e.jsx(de,{edge:"end",color:"error",onClick:()=>Y(a.id),children:e.jsx(fe,{size:18})})})]},a.id)})}):e.jsx(c,{variant:"body2",color:"text.secondary",sx:{py:2,textAlign:"center"},children:"No hay empresas asignadas a este usuario"})]})]})})})]}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(D,{direction:"row",spacing:2,justifyContent:"flex-end",sx:{mt:3},children:[e.jsx(E,{variant:"outlined",color:"secondary",onClick:Ne,disabled:j,children:"Cancelar"}),e.jsx(E,{variant:"contained",type:"submit",disabled:j,children:j?e.jsx($,{size:24}):t?"Actualizar":"Guardar"})]})})]})})};Ce.propTypes={user:z.object,isEdit:z.bool,refreshUsers:z.func};const Ye=Ce,qe=({open:s,onClose:t,user:i})=>{const[u,j]=p.useState(!1),[h,f]=p.useState(""),[m,A]=p.useState(""),[b,y]=p.useState({}),N=()=>{f(""),A(""),y({}),t()},I=()=>{const o={};return h?h.length<8&&(o.newPassword="La contraseña debe tener al menos 8 caracteres"):o.newPassword="La contraseña es requerida",m?h!==m&&(o.confirmPassword="Las contraseñas no coinciden"):o.confirmPassword="Confirme la contraseña",y(o),Object.keys(o).length===0},R=async()=>{if(I()){j(!0);try{await Re(i.userName,h),T({open:!0,message:"Contraseña cambiada exitosamente",variant:"alert",alert:{color:"success"}}),N()}catch(o){T({open:!0,message:o.message||"Error al cambiar la contraseña",variant:"alert",alert:{color:"error"}})}finally{j(!1)}}};return e.jsxs(ce,{open:s,onClose:N,maxWidth:"sm",fullWidth:!0,children:[e.jsx(me,{children:"Cambiar Contraseña"}),e.jsx(xe,{children:e.jsxs(D,{spacing:2,sx:{mt:2},children:[e.jsxs(c,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})]}),e.jsx(L,{fullWidth:!0,label:"Nueva Contraseña",type:"password",value:h,onChange:o=>f(o.target.value),error:!!b.newPassword,helperText:b.newPassword,disabled:u}),e.jsx(L,{fullWidth:!0,label:"Confirmar Contraseña",type:"password",value:m,onChange:o=>A(o.target.value),error:!!b.confirmPassword,helperText:b.confirmPassword,disabled:u})]})}),e.jsxs(ue,{children:[e.jsx(E,{onClick:N,disabled:u,children:"Cancelar"}),e.jsx(E,{variant:"contained",onClick:R,disabled:u,children:u?e.jsx($,{size:24}):"Cambiar Contraseña"})]})]})},Ze=qe,ze=({open:s,onClose:t,user:i})=>{const[u,j]=p.useState(!1),[h,f]=p.useState(""),{dialogState:m,openDialog:A,closeDialog:b}=Be(),{userCompanies:y,userCompaniesLoading:N}=he(i==null?void 0:i.id),{companies:I,companiesLoading:R}=je(),o=()=>{f(""),t()},B=I.filter(n=>!y.some(C=>C.companyId===n.id)),W=async()=>{if(!h){T({open:!0,message:"Seleccione una empresa",variant:"alert",alert:{color:"warning"}});return}j(!0);try{await ge(i.id,h),T({open:!0,message:"Empresa asignada exitosamente",variant:"alert",alert:{color:"success"}}),f("")}catch(n){T({open:!0,message:n.message||"Error al asignar empresa",variant:"alert",alert:{color:"error"}})}finally{j(!1)}},g=async n=>{const C=I.find(S=>S.id===n.companyId),l=(C==null?void 0:C.name)||n.companyName||"esta empresa";A({title:"Desasignar Empresa",message:`¿Está seguro de desasignar la empresa "${l}"?`,severity:"warning",confirmText:"Desasignar",onConfirm:async()=>{j(!0);try{await pe(n.id,i.id),T({open:!0,message:"Empresa desasignada exitosamente",variant:"alert",alert:{color:"success"}})}catch(S){T({open:!0,message:S.message||"Error al desasignar empresa",variant:"alert",alert:{color:"error"}})}finally{j(!1)}}})};return e.jsxs(ce,{open:s,onClose:o,maxWidth:"md",fullWidth:!0,children:[e.jsx(me,{children:"Asignar Empresas"}),e.jsx(xe,{children:e.jsxs(D,{spacing:3,sx:{mt:1},children:[e.jsxs(c,{variant:"body2",color:"text.secondary",children:["Usuario: ",e.jsx("strong",{children:i==null?void 0:i.userName})," (",i==null?void 0:i.fullName,")"]}),e.jsx(F,{}),e.jsxs(q,{children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:"Asignar Nueva Empresa"}),e.jsxs(D,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsxs(M,{fullWidth:!0,disabled:R||u,children:[e.jsx(V,{children:"Seleccionar Empresa"}),e.jsx(O,{value:h,onChange:n=>f(n.target.value),label:"Seleccionar Empresa",children:B.map(n=>e.jsxs(k,{value:n.id,children:[n.code," - ",n.name]},n.id))})]}),e.jsx(E,{variant:"contained",startIcon:e.jsx(re,{}),onClick:W,disabled:u||!h,children:"Asignar"})]}),B.length===0&&!R&&e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"No hay empresas disponibles para asignar"})]}),e.jsx(F,{}),e.jsxs(q,{children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:"Empresas Asignadas"}),N?e.jsx($,{}):y.length===0?e.jsx(c,{variant:"body2",color:"text.secondary",children:"No hay empresas asignadas"}):e.jsx(ne,{children:y.map((n,C)=>{const l=I.find(S=>S.id===n.companyId);return e.jsxs(K.Fragment,{children:[e.jsxs(te,{sx:{border:1,borderColor:"divider",borderRadius:1,mb:1,bgcolor:"background.paper"},children:[e.jsx(ie,{primary:e.jsxs(D,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(oe,{label:(l==null?void 0:l.code)||"N/A",size:"small",color:"primary"}),e.jsx(c,{variant:"subtitle2",children:(l==null?void 0:l.name)||"Empresa desconocida"})]}),secondary:`Asignada el: ${new Date(n.createdAt||Date.now()).toLocaleDateString("es-ES")}`}),e.jsx(le,{children:e.jsx(de,{edge:"end",color:"error",onClick:()=>g(n),disabled:u,children:e.jsx(fe,{size:20})})})]}),C<y.length-1&&e.jsx(F,{})]},n.id)})})]})]})}),e.jsx(ue,{children:e.jsx(E,{onClick:o,disabled:u,children:"Cerrar"})}),e.jsx(Fe,{open:m.open,title:m.title,message:m.message,onConfirm:m.onConfirm,onCancel:b,confirmText:m.confirmText,cancelText:m.cancelText,severity:m.severity})]})},ea=ze;z.object,z.func;export{ea as A,Ze as C,Ye as U};
